{{- $job := lookup "batch/v1" "Job" .Release.Namespace "init-pgsql" -}}
{{- $dbHost := printf "pgsql.%s.svc.cluster.local" .Release.Namespace -}}
{{- if not $job }}
kind: Job
apiVersion: batch/v1
metadata:
  name: init-pgsql
  labels:
    {{- include "cluster-iq.labels" . | nindent 4 }}
    {{- include "cluster-iq.componentLabels" "database" | nindent 4 }}
spec:
  manualSelector: false
  backoffLimit: 6
  completions: 1
  template:
    metadata:
      labels:
        {{- include "cluster-iq.labels" . | nindent 8 }}
        {{- include "cluster-iq.componentLabels" "database" | nindent 8 }}
    spec:
      volumes:
        - name: init
          configMap:
            name: postgresql-init
      containers:
        - name: init-pgsql
          command:
            - /bin/sh
            - '-c'
          imagePullPolicy: Always
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
          volumeMounts:
            - name: init
              mountPath: /var/lib/pgsql/init.sql
              subPath: init.sql
            - name: cron
              mountPath: /var/lib/pgsql/cron.sql
              subPath: cron.sql
          envFrom:
            - secretRef:
                name: postgresql
          image: "{{ .Values.database.image.repository }}:{{ .Values.database.image.tag | default .Chart.AppVersion }}"
          args:
            - |
              echo "Waiting for PGSQL to start up"
              while true; do
                  psql postgresql://$POSTGRESQL_USER:$POSTGRESQL_PASSWORD@{{ $dbHost }}:{{ .Values.database.service.port }}/$POSTGRESQL_DATABASE -c "SELECT true" && break || sleep 2;
              done

              echo "Initializing ClusterIQ Database"
              psql postgresql://$POSTGRESQL_USER:$POSTGRESQL_PASSWORD@{{ $dbHost }}:{{ .Values.database.service.port }}/$POSTGRESQL_DATABASE < /var/lib/pgsql/init.sql && { echo "Ok"; } || { echo "Initialization Failed"; exit 1; }

              echo "Creating PG_CRON tasks"
              psql postgresql://postgres:$POSTGRESQL_ADMIN_PASSWORD@{{ $dbHost }}:{{ .Values.database.service.port }}/postgres < /var/lib/pgsql/cron.sql && { echo "Ok"; } || { echo "Cron Tasks creation Failed"; exit 1; }

              echo "Done!"
      restartPolicy: OnFailure
{{- end }}
